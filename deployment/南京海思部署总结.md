南京海思部署总结
======================================================================

1. 网络规划

| 主机名       | 公网IP      | mask        | gateway   |DNS            |iBMC公网IP  |子网IP      |
|:----------- |:-----------|:------------|:----------|:--------------|:-----------|:-----------|
| atlas01     |121.37.54.23|255.255.255.0|121.37.54.1|114.114.114.114|121.37.54.26|            |
| atlas02     |121.37.54.25|255.255.255.0|121.37.54.1|114.114.114.114|121.37.54.26|            |
| atlas03     |121.37.54.27|255.255.255.0|121.37.54.1|114.114.114.114|121.37.54.26|            |

* iBMC配置（已配置）：

   用户名：Administrator
   密码：Admin@9000

防火墙：从外访问内部的端口；　8080, 443, 22, jupyter 转入的端口范围 30000 ~ 32767 

2个dns，对内，对外
外界的dns maping ，对外的，到每个机器的

内部的NDS：帮我们ssh cluster  节点直接是通过内部dns，internal 的dns resolver；

内部网络都写在 /etc/hosts  
search huawei-nanjing.sigsus.cn 


增龙：

2. NPU 昇腾芯片驱动安装包，昇腾芯片驱动固件安装包 待安装。

3. Ubuntu18.04.1 系统安装

   指导文档：https://support.huawei.com/enterprise/zh/doc/EDOC1100136593/40d0378e

4. NPU 驱动安装


https://support.huawei.com/enterprise/zh/doc/EDOC1100136593/40d0378e我弄好一台了，就是按这个指导书，然后分区的时候闲erase掉就好了

加入节点
---------------------------------------------------------------------------------------------
[ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables]: /proc/sys/net/bridge/bridge-nf-call-iptables does not exist
[ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1

解决方法：
modprobe br_netfilter
echo 1 > /proc/sys/net/bridge/bridge-nf-call-iptables

1. 问题 2 
cannot execute 'docker info -f {{.CgroupDriver}}': executable file not found in $PATH
解决方法：
systemctl enable docker.service
apt install docker.io -y

镜像拉取超慢！2h
./deploy.py --verbose --archtype arm64 docker push webui3
./deploy.py --nocache --archtype arm64 docker push custom-user-dashboard-frontend
./deploy.py --nocache --archtype arm64 docker push custom-user-dashboard-backend

./deploy.py --archtype arm64 docker push repairmanager2 超过45min
./deploy.py --verbose --archtype arm64 docker push init-container 超过1h
mysql 配置：
----------------------------------------------------------------------------------------
apulis#2019#wednesday
update user set host='%' where user='root';
Grant all privileges on test.* to 'root'@'%';
alter user root identified with mysql_native_password by 'apulis#2019#wednesday';
alter user 'root'@'%' identified with mysql_native_password by 'apulis#2019#wednesday';
flush privileges;

http://127.37.54.27:3083/
http://127.37.54.27/custom-user-dashboard


FD有32个版本的限制，推送前建议查询版本情况，让用户选择替换或更新策略。


* 每提交一个job；restfullapi 都要同步ubuntu apt！
* 每个Job 所用的镜像都要从docker hub 拉取 

* 查看Jobmanger 运行配置：
/dlwsdata/jobfiles/200711/e78c1ad1-6ca8-4cde-a07a-e197666f0f68

Submit training job,Manage VC,View VC,View all users jobs,View and manage all users job
View cluster status
Manage user
Cloud inference
Edge inference
/home/HwHiAiUser/apulis_platform/src/ClusterBootstrap
问题
====================================================================================

1. 网络环境要支持企业组网

2. 安装组件要有清晰的清单

3. 配置脚本的ssh端口要支持动态绑定

4. 码云上传的代码还要仔细核对

5. NPU状态检查

for i in {0..7}; do hccn_tool -i ${i} -link -g; done

npu-smi info

cat /var/log/npu/npu_smi/device0

6. NPU 网卡配置
   ```
   hccn_tool -i 0 -ip -s address 192.168.10.1 netmask 255.255.255.0
   hccn_tool -i 1 -ip -s address 192.168.20.1 netmask 255.255.255.0
   hccn_tool -i 2 -ip -s address 192.168.30.1 netmask 255.255.255.0
   hccn_tool -i 3 -ip -s address 192.168.40.1 netmask 255.255.255.0
   hccn_tool -i 4 -ip -s address 192.168.10.2 netmask 255.255.255.0
   hccn_tool -i 5 -ip -s address 192.168.20.2 netmask 255.255.255.0
   hccn_tool -i 6 -ip -s address 192.168.30.2 netmask 255.255.255.0
   hccn_tool -i 7 -ip -s address 192.168.40.2 netmask 255.255.255.0
   ```

   

进度总结：
1. 3台atlas 系统，网卡驱动，NPU驱动，系统工具包都已经安装完毕
2. 平台依赖的 k8s 集群已部署起来

阻塞因素和风险：
1. 对华为办公网络开放程度预判不足，SSH 访问端口，k8s依赖包的下载网络都被阻塞
2. 平台依赖镜像包需要在部署过程观察是否还会受到网络阻塞

后续完善：
1. 平台会进一步完善对企业网络的支持
2. 对网络依赖高的安装包，镜像会维护在apulis开放的docker仓库，方便后续平台更新维护

ping 返回内网IP address；


部署总结
==========================================================================

总体checklist
==========================================================================

